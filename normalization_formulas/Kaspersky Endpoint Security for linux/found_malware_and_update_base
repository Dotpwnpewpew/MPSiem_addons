#<14>Apr 1 09:39:20 host1 kesl: {"EventType": "ThreatDetected","EventId": "1197793","Initiator": "Product","Date": "2022-04-01 09:39:20","DangerLevel": "Critical","DetectName": "EICAR-Test-File","DetectType": "Virware","DetectCertainty": "Sure","DetectSource": "Local","FileName": "/root/eicar.com","ObjectName": "File","TaskId": "1","RuntimeTaskId": "3","TaskName": "File_Threat_Protection","TaskType": "OAS","Md5Hash": "69630e4574ec6798239b091cda43dca0","AccessUser": "root","AccessUserId": "0","FileOwner": "root","FileOwnerId": "0","FileSize": "69"}
#<14>Apr 7 08:11:48 host1 kesl: {"EventType": "AVBasesAreTotallyOutOfDate","EventId": "1197823","Initiator": "Product","Date": "2022-04-07 08:11:48","DangerLevel": "Critical","TaskName": "Update","TaskId": "6","AVBasesDate": "2022-02-22 23:23:00"}

TEXT='<{NUMBER}>{time=DATETIME} {event_src.hostname=HOSTNAME} 
        kesl{"["?}{NUMBER?}{"]"?}: {$message_kesl=REST}'
        
submessage("JSON","action data",$message_kesl)
subformula "action data"
    JSON = ''
    COND =  ($EventType=="ThreatDetected" or $EventType=="ObjectDeleted" or $EventType=="AVBasesAreTotallyOutOfDate")
endsubformula

# found malware
object.path=$FileName
object.value = $EventType

if find_substr(object.path,'/') != null then
    $f = csv(object.path,'/', '`')
    object.name = $f[length($f)-1]      # имя файла, содержащего вредонос
endif

if object.value == 'ThreatDetected' then
	importance = "high"
    action = "detect"
    
    object = "malware"
    subject = "process"
    status = "success"

    event_src.vendor = "kaspersky"
    event_src.title = "kaspersky_security_for_linux"
    event_src.category = "Anti-virus"

    category.generic = "Malware"
    category.high = "Miscellaneous"
    category.low = "Detection"
    event_src.category = "Host security"
elif object.value == 'ObjectDeleted' then
	importance = "info"
    action = "protect"
    
    object = "malware"
    subject = "process"
    status = "success"

    event_src.vendor = "kaspersky"
    event_src.title = "kaspersky_security_for_linux"
    event_src.category = "Anti-virus"

    category.generic = "Malware"
    category.high = "Miscellaneous"
    category.low = "Detection"
    event_src.category = "Host security"

# update base
elif object.value == 'AVBasesAreTotallyOutOfDate' and $TaskName == "Update" then
	action = "install"
    object = "update"
    status = "success"

    object.type = "signature database"
	event_src.vendor = "kaspersky"
    event_src.title = "kaspersky_security_for_linux"
    event_src.category = "Anti-virus"
    event_src.category = "Host security"
endif


id = "Dotpwnpewpew_Kaspersky_for_linux_KESL"

# Metadata
# id = "Incoma_Kaspersky_for_linux_KESL" and object.value = "AVBasesAreTotallyOutOfDate"
# Базы данных антивирусных сигнатур и угроз обновлены на узле {event_src.hostname}

# id = "Incoma_Kaspersky_for_linux_KESL" and object.value = "ObjectDeleted"
# На узле {event_src.hostname} удален зараженный вирусом файл {object.name}

# id = "Incoma_Kaspersky_for_linux_KESL" and object.value = "ThreatDetected"
# На узле {event_src.hostname} обнаружен зараженный вирусом файл {object.name}
